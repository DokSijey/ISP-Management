<!-- HEAD STYLES -->
 <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <!-- Include SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Optional Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="<?= base_url('/assets/css/styleadmin.css') ?>">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<style>
  html, body {
    height: 100%;
    margin: 0;
  }
</style>

<!-- WRAPPER FOR FULL HEIGHT LAYOUT -->
<div class="d-flex" style="height: 100vh; overflow: hidden;">

  <!-- SIDEBAR -->
  <div class="bg-light border-end shadow-sm" style="width: 240px; height: 100vh;">
    <div class="sidebar-heading text-center py-4 text-muted">
      <strong><?= session()->get('area') ?> Admin</strong>
    </div>
    <div class="list-group list-group-flush">

      <!-- Your collapsible sidebar buttons here (unchanged) -->
      <!-- MANAGE SUBSCRIBERS -->
      <button class="list-group-item list-group-item-action px-3 py-2 text-start w-100 d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse" data-bs-target="#manageSubscribers" aria-expanded="false" aria-controls="manageSubscribers">
        <span><i class="fas fa-users"></i> Manage Subscribers</span>
        <i class="fas fa-chevron-down"></i>
      </button>
      <div class="collapse" id="manageSubscribers">
        <a href="<?= base_url('admin/subscribers') ?>" class="list-group-item list-group-item-action px-4 py-2">Subscribers List</a>
        <a href="<?= base_url('admin/billings') ?>" class="list-group-item list-group-item-action px-4 py-2">Set Billing</a>
      </div>

      <!-- MANAGE APPLICATIONS -->
      <button class="list-group-item list-group-item-action px-3 py-2 text-start w-100 d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse" data-bs-target="#manageApplications" aria-expanded="false" aria-controls="manageApplications">
        <span><i class="fas fa-file-alt"></i> Manage Applications</span>
        <i class="fas fa-chevron-down"></i>
      </button>
      <div class="collapse" id="manageApplications">
        <a href="<?= base_url('admin/pending-applications') ?>" class="list-group-item list-group-item-action px-4 py-2">Pending Applications</a>
        <a href="<?= base_url('admin/approved-applications') ?>" class="list-group-item list-group-item-action px-4 py-2">Approved Applications</a>
        <a href="<?= base_url('admin/declined-applications') ?>" class="list-group-item list-group-item-action px-4 py-2">Declined Applications</a>
      </div>
              <!-- TECHNICIAN -->
      <button class="list-group-item list-group-item-action px-3 py-2 text-start w-100 d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse" data-bs-target="#technician" aria-expanded="false" aria-controls="technician">
        <span><i class="fas fa-cogs"></i> Technician</span>
        <i class="fas fa-chevron-down"></i>
      </button>
      <div class="collapse" id="technician">
        <button class="list-group-item list-group-item-action px-4 py-2 text-start w-100 d-flex justify-content-between align-items-center"
                data-bs-toggle="collapse" data-bs-target="#ticketsPending" aria-expanded="false" aria-controls="ticketsPending">
          <span>Ticket Requests</span>
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="collapse" id="ticketsPending">
          <a href="<?= base_url('admin/install-tickets') ?>" class="list-group-item list-group-item-action px-5 py-2">Install Tickets</a>
          <a href="<?= base_url('admin/repair-tickets') ?>" class="list-group-item list-group-item-action px-5 py-2">Repair Tickets</a>
        </div>
        <a href="<?= base_url('admin/generate-ticket') ?>" class="list-group-item list-group-item-action px-4 py-2">Generate Repair Ticket</a>
      </div>
      <!-- BILLINGS -->
      <button class="list-group-item list-group-item-action px-3 py-2 text-start w-100 d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse" data-bs-target="#billingMenu" aria-expanded="false" aria-controls="billingMenu">
        <span><i class="fas fa-money-bill-wave"></i> Billings</span>
        <i class="fas fa-chevron-down"></i>
      </button>
      <div class="collapse" id="billingMenu">
        <a href="<?= base_url('admin/billing-status') ?>" class="list-group-item list-group-item-action px-4 py-2">Billing Status</a>
      </div>
      <!-- FINANCE -->
      <button class="list-group-item list-group-item-action px-3 py-2 text-start w-100 d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse" data-bs-target="#finance" aria-expanded="false" aria-controls="finance">
        <span><i class="fas fa-dollar-sign"></i> Finance</span>
        <i class="fas fa-chevron-down"></i>
      </button>
      <div class="collapse" id="finance">
        <a href="<?= base_url('admin/finance/create') ?>" class="list-group-item list-group-item-action px-4 py-2">Create Record</a>
        <a href="<?= base_url('admin/finance/revenue-and-expenses') ?>" class="list-group-item list-group-item-action px-4 py-2">Revenue and Expenses</a>
        <a href="<?= base_url('admin/finance/monthly-report') ?>" class="list-group-item list-group-item-action px-4 py-2">Monthly Finance Report</a>
      </div>


      
      <!-- REPORTS -->
      <button class="list-group-item list-group-item-action px-3 py-2 text-start w-100 d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse" data-bs-target="#generateReports" aria-expanded="false" aria-controls="generateReports">
        <span><i class="fas fa-chart-line"></i> Generate Reports</span>
        <i class="fas fa-chevron-down"></i>
      </button>
      <div class="collapse" id="generateReports">
    <a href="#" class="list-group-item list-group-item-action px-4 py-2" onclick="promptDownloadReport()">Generate a Report (Pick)</a>
</div>

  <!-- LOGS -->
<a href="#" id="viewLogsBtn" class="list-group-item list-group-item-action px-3 py-2">
  <i class="fas fa-clipboard-list"></i> Logs
</a>


    </div>
  </div>

  <!-- MAIN CONTENT (NAVBAR + PAGE CONTENT) -->
  <div class="flex-grow-1 d-flex flex-column" style="overflow-y: auto;">

    <!-- NAVBAR -->
    <nav class="navbar navbar-light px-4" style="background-color: #f8f9fa;">
      <a style="text-decoration: none;" href="<?= base_url('admin/dashboard') ?>">
        <span class="brand-name fs-1 text-dark">ALLSTAR TECH</span>
      </a>
      <div class="d-flex align-items-center gap-3 ms-auto text-muted">
        <div id="clock" class="fw-bold"></div>
        <div id="date" class="fw-bold"></div>
        <a class="btn btn-outline-dark btn-sm" href="<?= base_url('admin/logout') ?>">Logout</a>
      </div>
    </nav>


<!-- JS SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function updateClockAndDate() {
    const now = new Date();
    const clock = now.toLocaleTimeString();
    const date = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('clock').textContent = clock;
    document.getElementById('date').textContent = date;
  }
  setInterval(updateClockAndDate, 1000);
  updateClockAndDate();

function promptDownloadReport() {
    Swal.fire({
        title: 'Pick a Report',
        input: 'select',
        inputOptions: {
            'subscribers_report': 'Subscribers Report',
            'billing_report': 'Billing Report',
            'install_tickets': 'Install Tickets',
            'repair_tickets': 'Repair Tickets'
        },
        inputPlaceholder: 'Select a report to generate',
        showCancelButton: true,
        confirmButtonText: 'Generate and Download',
        cancelButtonText: 'Cancel',
        preConfirm: (selectedReport) => {
            console.log('Selected Report:', selectedReport); // Log the selected report
            if (!selectedReport) {
                Swal.showValidationMessage('Please select a report');
            }
            return selectedReport;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            console.log('Report Generation Confirmed:', result.value); // Log confirmation result
            const report = result.value;
            Swal.fire('Generating report...', '', 'info');
            generateReport(report);
        }
    });
}

// This function can either generate the report on the front-end or call a PHP method via AJAX.
function generateReport(report) {
    console.log('Generating Report for:', report); // Log which report is being generated

    if (report === 'subscribers_report') {
        console.log('Redirecting to generate subscribers report...');
        window.location.href = '/admin/generate-subscribers-report';

    } else if (report === 'billing_report') {
        console.log('Redirecting to generate billing report...');
        window.location.href = '/admin/generate-billing-report';

    } else if (report === 'install_tickets' || report === 'repair_tickets') {
        // SweetAlert2 month input for both install and repair
        Swal.fire({
            title: 'Select Month',
            input: 'month',
            inputLabel: 'Choose the month to generate report for:',
            inputAttributes: {
                min: '2024-01',
                max: '2025-12'
            },
            showCancelButton: true,
            confirmButtonText: 'Generate',
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                const selectedMonth = result.value; // Format: YYYY-MM
                console.log('Selected Month:', selectedMonth); // Log the selected month

                if (report === 'install_tickets') {
                    console.log('Redirecting to generate install tickets report for month:', selectedMonth);
                    window.location.href = '/admin/generate-install-tickets-report?month=' + encodeURIComponent(selectedMonth);
                } else if (report === 'repair_tickets') {
                    console.log('Redirecting to generate repair tickets report for month:', selectedMonth);
                    window.location.href = '/admin/generate-repair-tickets-report?month=' + encodeURIComponent(selectedMonth);
                }
            }
        });
    }
}
document.getElementById('viewLogsBtn').addEventListener('click', function (e) {
    e.preventDefault();

    fetch('<?= site_url('admin/fetch-logs') ?>')
    .then(response => response.json())
    .then(data => {
        if (!data || data.length === 0) {
            Swal.fire('No logs found.', '', 'info');
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-start">
                    <thead class="table">
                        <tr>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        data.forEach(log => {
            html += `
                <tr>
                    <td>${log.area}</td>
                    <td>${log.action}</td>
                    <td>${log.details}</td>          
                    <td>${log.timestamp}</td>
                </tr>`;
        });

        html += '</tbody></table></div>';

        Swal.fire({
            title: 'Action Logs',
            html: html,
            width: '70%',
            showCloseButton: true,
            confirmButtonText: 'Close'
        });
    })
    .catch(err => {
        console.error(err);
        Swal.fire('Error fetching logs.', '', 'error');
    });
});

</script>
